<div class="chatlog__message-group">
  <div class="chatlog__author-avatar-container">
    <img class="chatlog__author-avatar" src="https://cdn.discordapp.com/avatars/293572563010060288/92f572b5e1ef6656a55498787c15a5ad.png?size=128" alt="Avatar" loading="lazy">
  </div>
  <div class="chatlog__messages">
    <span class="chatlog__author-name" title="tarunon#9603" data-user-id="293572563010060288" style="color: rgb(231,76,60)">tarunon</span>
    <a href="/channels/306995750418513920?category=main&amp;channel=swift-2&amp;message_id=821352527324905473"><span class="chatlog__timestamp">16-Mar-21 11:41 AM</span></a>
    <div class="chatlog__message " data-message-id="821347439117074453" id="message-821347439117074453" title="Message sent: 16-Mar-21 11:41 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace"><a href="https://discord.com/channels/291054398077927425/430242233468452865/821280456557199370" onclick="scrollToMessage(event, '821280456557199370')">https://discord.com/channels/291054398077927425/430242233468452865/821280456557199370</a> のOptionalの話の詳細 <span class="mention" title="Iceman#5499">@Iceman</span> FYI</span>
        </div>
      </div>
      <div class="chatlog__reactions">
        <div class="chatlog__reaction" title="eyes">
          <img class="emoji emoji--small" alt="👀" src="https://twemoji.maxcdn.com/2/svg/1f440.svg" loading="lazy">
          <span class="chatlog__reaction-count">1</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821347579044429826" id="message-821347579044429826" title="Message sent: 16-Mar-21 11:42 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">議論がとっ散らかるとよくないのでサブタイプが存在することによって発生する大きな問題点を2つ、整理します。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821348331073699841" id="message-821348331073699841" title="Message sent: 16-Mar-21 11:45 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">まず1つ目がサブタイプであるにも関わらず、実体が異なってしまうという点 <div class="pre pre--multiline language-swift">var s = 1 var a: Int = s var b: Int? = s</div> のaとbが異なるということですね。クラスサブクラス、あるいはExistentialと具体型の関係なら、これは同じものを指すわけです。(Existentialは厳密には異なるが省略) <div class="pre pre--multiline language-swift">var s = Cat() var a: Animal = s var b: Cat = s</div> この結果発生する問題として、 実態が異なっているということを知っているユーザーと知らないユーザーとの間で、期待する挙動に差が出てきます。例えば</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821348647374684171" id="message-821348647374684171" title="Message sent: 16-Mar-21 11:46 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace"><a href="https://discord.com/channels/291054398077927425/375206337937801216/806433474579005440" onclick="scrollToMessage(event, '806433474579005440')">https://discord.com/channels/291054398077927425/375206337937801216/806433474579005440</a> 最近発生したバグとされるこの挙動。 AnyHashableにInt?の値を入れた時に、Intを入れた時と異なってしまう、というバグ</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821348808893267989" id="message-821348808893267989" title="Message sent: 16-Mar-21 11:46 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">でもこれは、「いやいやそうは言っても <span class="pre pre--inline">.some(1)</span> と <span class="pre pre--inline">1</span> は別でしょ」っていう理解のユーザーからは、AnyHashableの値が異なることこそが期待される挙動なはずです。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821349096941158400" id="message-821349096941158400" title="Message sent: 16-Mar-21 11:48 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">このOptionalであるか否かが同一かどうかというのは、文脈によっても期待される挙動が異なるので、ケースバイケースでコンパイラの挙動が変わることが期待されてしまう。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821349150502682675" id="message-821349150502682675" title="Message sent: 16-Mar-21 11:48 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">片方を立てれば片方は立たなくなる、という問題の根源になりえるわけです。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821349222254772245" id="message-821349222254772245" title="Message sent: 16-Mar-21 11:48 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">次 2つ目、サブタイプのルールづけに優先順位が必要という話。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821350073941229600" id="message-821350073941229600" title="Message sent: 16-Mar-21 11:51 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">これは結構私は方々でぶーを垂れてるので知ってるかもですが、 TがT?のサブタイプである UがTのサブタイプであるならばU?はT?のサブタイプである この2点がSwiftでは許可されています。で、下のコードはコンパイルが通る。 <div class="pre pre--multiline language-swift">var s = Cat() var a: Animal = s // CatとAnimalのサブタイプ関係が成り立つことを示す var b: Cat? = s var c: Animal? = b</div> U?はT?のサブタイプ、は具体のコードとしては、 <span class="pre pre--inline">UITableViewController?</span> な変数が <span class="pre pre--inline">UIViewController?</span> に渡せる、というのが頻出すると思います。</span>
          <span class="chatlog__edited-timestamp" title="16-Mar-21 12:25 PM">(edited)</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821350287096545332" id="message-821350287096545332" title="Message sent: 16-Mar-21 11:52 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">もちろんOptionalは実体は別なので、暗黙的な変換が挟まるわけですが、どうなっているかというと</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821350462551752704" id="message-821350462551752704" title="Message sent: 16-Mar-21 11:53 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">
            <div class="pre pre--multiline language-swift">var s = Cat() var a: Animal = s // CatとAnimalのサブタイプ関係が成り立つことを示す var b: Cat? = .some(s) var c: Animal? = b.map { $0 as Animal }</div> mapのところは本当は違うと思うんですが、まあ雑にこんな感じ。
          </span>
          <span class="chatlog__edited-timestamp" title="16-Mar-21 11:53 AM">(edited)</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821350630307790900" id="message-821350630307790900" title="Message sent: 16-Mar-21 11:54 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">じゃあここに一行付け加えて、これはどうあるべきでしょうか。というのが問題になります。 <div class="pre pre--multiline language-swift">var d: Cat?? = b // b: Cat?</div></span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821350888341504030" id="message-821350888341504030" title="Message sent: 16-Mar-21 11:55 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">解釈としては2通りあって、 <div class="pre pre--multiline language-swift">1. オプショナルのサブタイプなので.someでラップする 2. CatはCat?のサブタイプなのだから、.mapでOK</div></span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821351511627268127" id="message-821351511627268127" title="Message sent: 16-Mar-21 11:57 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">今このコードだと、Cat?は.someなので結果は同じなんですが、Cat?が.noneだと、1,2のどちらを採用するかで結果が変わります。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821351845002870846" id="message-821351845002870846" title="Message sent: 16-Mar-21 11:58 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">
            <div class="pre pre--multiline language-swift">// 1. var d1 = .some(b) // 見たまま.some(.none)になります // 2. var d2 = b.map { $0 as Cat? } // これは.noneになります</div> じゃあこれがどういう問題を引き起こしたかというと
          </span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821351910740983838" id="message-821351910740983838" title="Message sent: 16-Mar-21 11:59 AM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">過去のSwiftではコンテキストの差によって2.の変換が採用されていた時代がありました。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="821352527324905473" id="message-821352527324905473" title="Message sent: 16-Mar-21 12:01 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">あった、これかな <a href="https://bugs.swift.org/browse/SR-6126?filter=-2">https://bugs.swift.org/browse/SR-6126?filter=-2</a></span>
        </div>
      </div>
    </div>
  </div>
</div>