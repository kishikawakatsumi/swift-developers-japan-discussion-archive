<div class="chatlog__message-group">
  <div class="chatlog__author-avatar-container">
    <img class="chatlog__author-avatar" src="https://cdn.discordapp.com/avatars/291075091025100810/39d60f97ea2bca395f1992c42f25107c.png?size=128" alt="Avatar" loading="lazy">
  </div>
  <div class="chatlog__messages">
    <span class="chatlog__author-name" title="kishikawakatsumi#7600" data-user-id="291075091025100810" style="color: rgb(155,89,182)">Kishikawa Katsumi</span>
    <span class="chatlog__timestamp">21-Apr-19 01:49 PM</span>
    <div class="chatlog__message " data-message-id="569520021034762256" id="message-569520021034762256" title="Message sent: 21-Apr-19 01:49 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace"><span class="mention" title="kateinoigakukun#2184">@kateinoigakukun</span> １年前を思い出しながらSwiftPowerAssertから<span class="pre pre--inline">-dump-ast</span>のParserの部分を独立させて、現行の環境で動くようにしました。よかったら参考にしてください。 <a href="https://github.com/kishikawakatsumi/SwiftAST">https://github.com/kishikawakatsumi/SwiftAST</a> 使い方は <div class="pre pre--multiline nohighlight">swift-ast parse [FILE_PATH_TO_PARSE] -buildCommand [BUILD_COMMAND_TO_BUILD_THE_PROJECT]</div> 例えば <div class="pre pre--multiline nohighlight">path/to/swift-ast parse "./Framework/Sources/SpreadsheetView.swift" -buildCommand xcodebuild -scheme SpreadsheetView</div> や、 <div class="pre pre--multiline nohighlight">path/to/swift-ast parse ./Lib/KeychainAccess/Keychain.swift -buildCommand xcodebuild -scheme KeychainAccess -sdk iphonesimulator -destination "name=iPhone Xs,OS=12.2"</div> です。 以下、思い出したことを書きます。</span>
          <span class="chatlog__edited-timestamp" title="21-Apr-19 01:49 PM">(edited)</span>
        </div>
      </div>
      <div class="chatlog__embed">
        <div class="chatlog__embed-color-pill" style="background-color: rgba(30,35,39,255)"></div>
        <div class="chatlog__embed-content-container">
          <div class="chatlog__embed-content">
            <div class="chatlog__embed-text">
              <div class="chatlog__embed-title">
                <a class="chatlog__embed-title-link" href="https://github.com/kishikawakatsumi/SwiftAST">
                  <div class="markdown preserve-whitespace">kishikawakatsumi/SwiftAST</div>
                </a>
              </div>
              <div class="chatlog__embed-description">
                <div class="markdown preserve-whitespace">Experimental project for parsing an output that <span class="pre pre--inline">swift -dump-ast</span> produces - kishikawakatsumi/SwiftAST</div>
              </div>
            </div>
            <div class="chatlog__embed-thumbnail-container">
              <a class="chatlog__embed-thumbnail-link" href="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610">
                <img class="chatlog__embed-thumbnail" src="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610" alt="Thumbnail" loading="lazy">
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="chatlog__reactions">
        <div class="chatlog__reaction" title="eyes">
          <img class="emoji emoji--small" alt="👀" src="https://twemoji.maxcdn.com/2/svg/1f440.svg" loading="lazy">
          <span class="chatlog__reaction-count">1</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="569521772085510149" id="message-569521772085510149" title="Message sent: 21-Apr-19 01:56 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace"><span class="pre pre--inline">-dump-ast</span>は全ての型が解決しているので原則としてコンパイルが成功する必要があります。簡単な（依存関係がない）ファイルなら簡単ですが、他のファイルやモジュールを参照している場合は同じモジュールのファイルの場合はそれを一緒に渡す、別モジュールの場合はそれを先にビルドする必要があります。 なので、時間は余計にかかるのですが、 <a href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftAST/XcodebuildTool.swift#L37-L42">https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftAST/XcodebuildTool.swift#L37-L42</a> のように <span class="pre pre--inline">swift -dump-ast</span> を実行する前にまずビルドしています。 ビルドエラーが起こる状態で <span class="pre pre--inline">swift -dump-ast</span> を実行した場合、単に失敗するか不完全なASTが出力されます。 <span class="pre pre--inline">swift -dump-ast</span> の出力自体が謎であるのにさらに不完全なASTを相手にするのは無理なので、最初のキモは確実にビルドできるパラメータを組み立てることです。</span>
          <span class="chatlog__edited-timestamp" title="21-Apr-19 01:58 PM">(edited)</span>
        </div>
      </div>
      <div class="chatlog__embed">
        <div class="chatlog__embed-color-pill" style="background-color: rgba(30,35,39,255)"></div>
        <div class="chatlog__embed-content-container">
          <div class="chatlog__embed-content">
            <div class="chatlog__embed-text">
              <div class="chatlog__embed-title">
                <a class="chatlog__embed-title-link" href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftAST/XcodebuildTool.swift">
                  <div class="markdown preserve-whitespace">kishikawakatsumi/SwiftAST</div>
                </a>
              </div>
              <div class="chatlog__embed-description">
                <div class="markdown preserve-whitespace">Experimental project for parsing an output that <span class="pre pre--inline">swift -dump-ast</span> produces - kishikawakatsumi/SwiftAST</div>
              </div>
            </div>
            <div class="chatlog__embed-thumbnail-container">
              <a class="chatlog__embed-thumbnail-link" href="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610">
                <img class="chatlog__embed-thumbnail" src="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610" alt="Thumbnail" loading="lazy">
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="569523165517053972" id="message-569523165517053972" title="Message sent: 21-Apr-19 02:01 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">最初のハードルを超えたら、完全なASTのテキストが手に入るので、それを読んでいくだけです。 難しいのは <span class="pre pre--inline">constructor_decl</span> や <span class="pre pre--inline">brace_stmt</span> <span class="pre pre--inline">assign_expr</span> といったノードの種類がよくわからないことと、それぞれがどういう属性を持っているかが当然Undocumentedでよくわからないところで、Parse自体はそれほど難しくないはず（目的にもよりますが）です。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="569524049605034019" id="message-569524049605034019" title="Message sent: 21-Apr-19 02:05 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace"><a href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftASTCore/SwiftAST.swift#L39-L46">https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftASTCore/SwiftAST.swift#L39-L46</a> ^ を見ると私がどのようにやったかがわかります。 <div class="pre pre--multiline nohighlight">private func process(sourceFile: URL, verbose: Bool = false) throws -&gt; AST { let arguments = buildArguments(source: sourceFile) let rawAST = try dumpAST(arguments: arguments) let tokens = tokenize(rawAST: rawAST) let node = lex(tokens: tokens) let root = parse(node: node) return root }</div>
            <span class="pre pre--inline">dumpAST(arguments:)</span>は<span class="pre pre--inline">swift -dump-ast</span>を実行します。 得られたテキストを<span class="pre pre--inline">tokenize(rawAST:)</span>でトークンに分割して、<span class="pre pre--inline">lex(tokens:)</span>でツリー構造を作ります。 最後に<span class="pre pre--inline">parse(node:)</span> でツリー構造のデータに意味を持たせます。</span>
        </div>
      </div>
      <div class="chatlog__embed">
        <div class="chatlog__embed-color-pill" style="background-color: rgba(30,35,39,255)"></div>
        <div class="chatlog__embed-content-container">
          <div class="chatlog__embed-content">
            <div class="chatlog__embed-text">
              <div class="chatlog__embed-title">
                <a class="chatlog__embed-title-link" href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftASTCore/SwiftAST.swift">
                  <div class="markdown preserve-whitespace">kishikawakatsumi/SwiftAST</div>
                </a>
              </div>
              <div class="chatlog__embed-description">
                <div class="markdown preserve-whitespace">Experimental project for parsing an output that <span class="pre pre--inline">swift -dump-ast</span> produces - kishikawakatsumi/SwiftAST</div>
              </div>
            </div>
            <div class="chatlog__embed-thumbnail-container">
              <a class="chatlog__embed-thumbnail-link" href="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610">
                <img class="chatlog__embed-thumbnail" src="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610" alt="Thumbnail" loading="lazy">
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="569525116589834251" id="message-569525116589834251" title="Message sent: 21-Apr-19 02:09 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace"><span class="pre pre--inline">-dump-ast</span>の出力はS式のように見えるのでカッコを頼りにしたくなりますが、別の意味のカッコが普通に（<span class="pre pre--inline">"</span>や<span class="pre pre--inline">'</span>に囲まれることなく）出てくるのでそれは難しいです。 代わりに行とインデントを使います。</span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="569525791252283412" id="message-569525791252283412" title="Message sent: 21-Apr-19 02:12 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">
            <div class="pre pre--multiline nohighlight">func tokenize(source: String) -&gt; [ASTToken] { var lines = [String]() for line in source.split(separator: "\n", omittingEmptySubsequences: false) { let trimmed = line.trimmingCharacters(in: .whitespaces) if trimmed.hasPrefix("(inherited_conformance") || trimmed.hasPrefix("(normal_conformance") || trimmed.hasPrefix("(abstract_conformance") || trimmed.hasPrefix("(specialized_conformance") || trimmed.hasPrefix("(assoc_type") || trimmed.hasPrefix("(value req") || !trimmed.hasPrefix("(") { continue } lines.append(String(line)) } ...</div>
            <span class="pre pre--inline">-dump-ast</span>の出力をまず行ごとに分割します。このとき、いくつかのプロジェクトでノイズになる行（実行コードには関係なく見える上にインデントがおかしい）が発見されたのでそれを取り除いています。
          </span>
        </div>
      </div>
    </div>
    <div class="chatlog__message " data-message-id="569527187900858379" id="message-569527187900858379" title="Message sent: 21-Apr-19 02:17 PM">
      <div class="chatlog__content">
        <div class="markdown">
          <span class="preserve-whitespace">そのあと、１行ごとに１文字ずつIterateしながらトークンに分割していきます。 私の場合は<span class="pre pre--inline">indent</span>（先頭の空白）、<span class="pre pre--inline">symbol</span>（シングルクオートで囲まれた文字列）、<span class="pre pre--inline">string</span>（ダブルクオートで囲まれた文字列）、<span class="pre pre--inline">token</span>（それ以外の文字列や記号）に分類しました。 <div class="pre pre--multiline nohighlight">class ASTToken { enum TokenType { case token case symbol case string case indent(Int) }</div></span>
        </div>
      </div>
    </div>
  </div>
</div>