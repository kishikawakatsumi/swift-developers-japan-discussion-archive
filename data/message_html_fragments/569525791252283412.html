<div class="chatlog__message-group">
  <div id="chatlog__message-container-569520021034762256" class="chatlog__message-container " data-message-id="569520021034762256">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <img class="chatlog__avatar" src="https://cdn.discordapp.com/avatars/291075091025100810/39d60f97ea2bca395f1992c42f25107c.png?size=512" alt="Avatar" loading="lazy">
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__header">
          <span class="chatlog__author" style="color: rgb(155, 89, 182)" title="kishikawakatsumi#7600" data-user-id="291075091025100810">Kishikawa Katsumi</span>
          <span class="chatlog__timestamp">21-Apr-19 01:49 PM</span>
        </div>
        <div class="chatlog__content chatlog__markdown">
          <span class="chatlog__markdown-preserve"><span class="chatlog__markdown-mention" title="kateinoigakukun#2184">@kateinoigakukun</span> １年前を思い出しながらSwiftPowerAssertから<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">-dump-ast</span>のParserの部分を独立させて、現行の環境で動くようにしました。よかったら参考にしてください。 <a href="https://github.com/kishikawakatsumi/SwiftAST">https://github.com/kishikawakatsumi/SwiftAST</a> 使い方は <div class="chatlog__markdown-pre chatlog__markdown-pre--multiline nohighlight">swift-ast parse [FILE_PATH_TO_PARSE] -buildCommand [BUILD_COMMAND_TO_BUILD_THE_PROJECT]</div> 例えば <div class="chatlog__markdown-pre chatlog__markdown-pre--multiline nohighlight">path/to/swift-ast parse "./Framework/Sources/SpreadsheetView.swift" -buildCommand xcodebuild -scheme SpreadsheetView</div> や、 <div class="chatlog__markdown-pre chatlog__markdown-pre--multiline nohighlight">path/to/swift-ast parse ./Lib/KeychainAccess/Keychain.swift -buildCommand xcodebuild -scheme KeychainAccess -sdk iphonesimulator -destination "name=iPhone Xs,OS=12.2"</div> です。 以下、思い出したことを書きます。</span>
          <span class="chatlog__edited-timestamp" title="21-Apr-19 01:49 PM">(edited)</span>
        </div>
        <div class="chatlog__embed">
          <div class="chatlog__embed-color-pill" style="background-color: rgba(30, 35, 39, 255)"></div>
          <div class="chatlog__embed-content-container">
            <div class="chatlog__embed-content">
              <div class="chatlog__embed-text">
                <div class="chatlog__embed-title">
                  <a class="chatlog__embed-title-link" href="https://github.com/kishikawakatsumi/SwiftAST">
                    <div class="chatlog__markdown chatlog__markdown-preserve">kishikawakatsumi/SwiftAST</div>
                  </a>
                </div>
                <div class="chatlog__embed-description">
                  <div class="chatlog__markdown chatlog__markdown-preserve">Experimental project for parsing an output that <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">swift -dump-ast</span> produces - kishikawakatsumi/SwiftAST</div>
                </div>
              </div>
              <div class="chatlog__embed-thumbnail-container">
                <a class="chatlog__embed-thumbnail-link" href="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610">
                  <img class="chatlog__embed-thumbnail" src="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610" alt="Thumbnail" loading="lazy">
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="chatlog__reactions">
          <div class="chatlog__reaction" title="eyes">
            <img class="chatlog__emoji chatlog__emoji--small" alt="👀" src="https://twemoji.maxcdn.com/2/svg/1f440.svg" loading="lazy">
            <span class="chatlog__reaction-count">1</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="chatlog__message-container-569521772085510149" class="chatlog__message-container " data-message-id="569521772085510149">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <div class="chatlog__short-timestamp" title="21-Apr-19 01:56 PM">13:56</div>
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__content chatlog__markdown">
          <span class="chatlog__markdown-preserve"><span class="chatlog__markdown-pre chatlog__markdown-pre--inline">-dump-ast</span>は全ての型が解決しているので原則としてコンパイルが成功する必要があります。簡単な（依存関係がない）ファイルなら簡単ですが、他のファイルやモジュールを参照している場合は同じモジュールのファイルの場合はそれを一緒に渡す、別モジュールの場合はそれを先にビルドする必要があります。 なので、時間は余計にかかるのですが、 <a href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftAST/XcodebuildTool.swift#L37-L42">https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftAST/XcodebuildTool.swift#L37-L42</a> のように <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">swift -dump-ast</span> を実行する前にまずビルドしています。 ビルドエラーが起こる状態で <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">swift -dump-ast</span> を実行した場合、単に失敗するか不完全なASTが出力されます。 <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">swift -dump-ast</span> の出力自体が謎であるのにさらに不完全なASTを相手にするのは無理なので、最初のキモは確実にビルドできるパラメータを組み立てることです。</span>
          <span class="chatlog__edited-timestamp" title="21-Apr-19 01:58 PM">(edited)</span>
        </div>
        <div class="chatlog__embed">
          <div class="chatlog__embed-color-pill" style="background-color: rgba(30, 35, 39, 255)"></div>
          <div class="chatlog__embed-content-container">
            <div class="chatlog__embed-content">
              <div class="chatlog__embed-text">
                <div class="chatlog__embed-title">
                  <a class="chatlog__embed-title-link" href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftAST/XcodebuildTool.swift">
                    <div class="chatlog__markdown chatlog__markdown-preserve">kishikawakatsumi/SwiftAST</div>
                  </a>
                </div>
                <div class="chatlog__embed-description">
                  <div class="chatlog__markdown chatlog__markdown-preserve">Experimental project for parsing an output that <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">swift -dump-ast</span> produces - kishikawakatsumi/SwiftAST</div>
                </div>
              </div>
              <div class="chatlog__embed-thumbnail-container">
                <a class="chatlog__embed-thumbnail-link" href="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610">
                  <img class="chatlog__embed-thumbnail" src="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610" alt="Thumbnail" loading="lazy">
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="chatlog__message-container-569523165517053972" class="chatlog__message-container " data-message-id="569523165517053972">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <div class="chatlog__short-timestamp" title="21-Apr-19 02:01 PM">14:01</div>
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__content chatlog__markdown">
          <span class="chatlog__markdown-preserve">最初のハードルを超えたら、完全なASTのテキストが手に入るので、それを読んでいくだけです。 難しいのは <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">constructor_decl</span> や <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">brace_stmt</span> <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">assign_expr</span> といったノードの種類がよくわからないことと、それぞれがどういう属性を持っているかが当然Undocumentedでよくわからないところで、Parse自体はそれほど難しくないはず（目的にもよりますが）です。</span>
        </div>
      </div>
    </div>
  </div>
  <div id="chatlog__message-container-569524049605034019" class="chatlog__message-container " data-message-id="569524049605034019">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <div class="chatlog__short-timestamp" title="21-Apr-19 02:05 PM">14:05</div>
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__content chatlog__markdown">
          <span class="chatlog__markdown-preserve"><a href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftASTCore/SwiftAST.swift#L39-L46">https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftASTCore/SwiftAST.swift#L39-L46</a> ^ を見ると私がどのようにやったかがわかります。 <div class="chatlog__markdown-pre chatlog__markdown-pre--multiline nohighlight">private func process(sourceFile: URL, verbose: Bool = false) throws -&gt; AST { let arguments = buildArguments(source: sourceFile) let rawAST = try dumpAST(arguments: arguments) let tokens = tokenize(rawAST: rawAST) let node = lex(tokens: tokens) let root = parse(node: node) return root }</div>
            <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">dumpAST(arguments:)</span>は<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">swift -dump-ast</span>を実行します。 得られたテキストを<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">tokenize(rawAST:)</span>でトークンに分割して、<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">lex(tokens:)</span>でツリー構造を作ります。 最後に<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">parse(node:)</span> でツリー構造のデータに意味を持たせます。</span>
        </div>
        <div class="chatlog__embed">
          <div class="chatlog__embed-color-pill" style="background-color: rgba(30, 35, 39, 255)"></div>
          <div class="chatlog__embed-content-container">
            <div class="chatlog__embed-content">
              <div class="chatlog__embed-text">
                <div class="chatlog__embed-title">
                  <a class="chatlog__embed-title-link" href="https://github.com/kishikawakatsumi/SwiftAST/blob/master/Sources/SwiftASTCore/SwiftAST.swift">
                    <div class="chatlog__markdown chatlog__markdown-preserve">kishikawakatsumi/SwiftAST</div>
                  </a>
                </div>
                <div class="chatlog__embed-description">
                  <div class="chatlog__markdown chatlog__markdown-preserve">Experimental project for parsing an output that <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">swift -dump-ast</span> produces - kishikawakatsumi/SwiftAST</div>
                </div>
              </div>
              <div class="chatlog__embed-thumbnail-container">
                <a class="chatlog__embed-thumbnail-link" href="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610">
                  <img class="chatlog__embed-thumbnail" src="https://images-ext-2.discordapp.net/external/Efjx42n3Kgv-92wTx1zUiHpY_-4QLaRCk4bPVM8i6aA/%3Fs%3D400%26v%3D4/https/avatars2.githubusercontent.com/u/40610" alt="Thumbnail" loading="lazy">
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="chatlog__message-container-569525116589834251" class="chatlog__message-container " data-message-id="569525116589834251">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <div class="chatlog__short-timestamp" title="21-Apr-19 02:09 PM">14:09</div>
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__content chatlog__markdown">
          <span class="chatlog__markdown-preserve"><span class="chatlog__markdown-pre chatlog__markdown-pre--inline">-dump-ast</span>の出力はS式のように見えるのでカッコを頼りにしたくなりますが、別の意味のカッコが普通に（<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">"</span>や<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">'</span>に囲まれることなく）出てくるのでそれは難しいです。 代わりに行とインデントを使います。</span>
        </div>
      </div>
    </div>
  </div>
  <div id="chatlog__message-container-569525791252283412" class="chatlog__message-container " data-message-id="569525791252283412">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <div class="chatlog__short-timestamp" title="21-Apr-19 02:12 PM">14:12</div>
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__content chatlog__markdown">
          <span class="chatlog__markdown-preserve">
            <div class="chatlog__markdown-pre chatlog__markdown-pre--multiline nohighlight">func tokenize(source: String) -&gt; [ASTToken] { var lines = [String]() for line in source.split(separator: "\n", omittingEmptySubsequences: false) { let trimmed = line.trimmingCharacters(in: .whitespaces) if trimmed.hasPrefix("(inherited_conformance") || trimmed.hasPrefix("(normal_conformance") || trimmed.hasPrefix("(abstract_conformance") || trimmed.hasPrefix("(specialized_conformance") || trimmed.hasPrefix("(assoc_type") || trimmed.hasPrefix("(value req") || !trimmed.hasPrefix("(") { continue } lines.append(String(line)) } ...</div>
            <span class="chatlog__markdown-pre chatlog__markdown-pre--inline">-dump-ast</span>の出力をまず行ごとに分割します。このとき、いくつかのプロジェクトでノイズになる行（実行コードには関係なく見える上にインデントがおかしい）が発見されたのでそれを取り除いています。
          </span>
        </div>
      </div>
    </div>
  </div>
  <div id="chatlog__message-container-569527187900858379" class="chatlog__message-container " data-message-id="569527187900858379">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <div class="chatlog__short-timestamp" title="21-Apr-19 02:17 PM">14:17</div>
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__content chatlog__markdown">
          <span class="chatlog__markdown-preserve">そのあと、１行ごとに１文字ずつIterateしながらトークンに分割していきます。 私の場合は<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">indent</span>（先頭の空白）、<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">symbol</span>（シングルクオートで囲まれた文字列）、<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">string</span>（ダブルクオートで囲まれた文字列）、<span class="chatlog__markdown-pre chatlog__markdown-pre--inline">token</span>（それ以外の文字列や記号）に分類しました。 <div class="chatlog__markdown-pre chatlog__markdown-pre--multiline nohighlight">class ASTToken { enum TokenType { case token case symbol case string case indent(Int) }</div></span>
        </div>
      </div>
    </div>
  </div>
</div>