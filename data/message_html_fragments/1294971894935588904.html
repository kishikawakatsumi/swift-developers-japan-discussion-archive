<div class="chatlog__message-group">
  <div id="chatlog__message-container-1294971894935588904" class="chatlog__message-container" data-message-id="1294971894935588904">
    <div class="chatlog__message">
      <div class="chatlog__message-aside"><img class="chatlog__avatar" src="https://cdn.discordapp.com/avatars/293624673265123328/accd07acc220a18568ba46a6e9ede18a.png?size=512" alt="Avatar" loading="lazy"></div>
      <div class="chatlog__message-primary">
        <div class="chatlog__header"><span class="chatlog__author" style="color:rgb(17,128,106)" title="koher" data-user-id="293624673265123328">koher</span> <a href="/channels/291054454793306112?category=main&amp;channel=swift&amp;message_id=1294971894935588904"><span class="chatlog__timestamp" title="Sunday, October 13, 2024 10:35 AM"></span></a><a href="#chatlog__message-container-1294971894935588904">10/13/2024 10:35 AM</a></div>
        <div class="chatlog__content chatlog__markdown"><span class="chatlog__markdown-preserve">質問です。 <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> は non-<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">Sendable</code> な型です。これを保持する <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">actor</code> を考えます。このとき、その <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> インスタンスはその <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">actor</code> インスタンスにisolateされます。 次に、その <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">actor</code> を <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizerDelegate</code> に準拠させ、保持している <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> インスタンスの <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">delegate</code> にセットします。 このとき、delegateメソッドは <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">nonisolated</code> である必要があるので、次のようになります。 <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">nonisolated func speechSynthesizer(_ synthesizer: AVSpeechSynthesizer, didFinish utterance: AVSpeechUtterance) { ... }</code> 一見、 <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">synthesizer</code> が <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">actor</code> のisolation domainの外に出てしまっているように見えますが、このdelegateメソッドは同期メソッドなので呼び出し元のcontextで呼び出されるため安全なはずです。 たとえば、今 <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> インスタンスは <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">actor</code> インスタンスにisolateされているので、 <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> がこのdelegateメソッドを呼び出しても <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">actor</code> インスタンスのcontextで呼び出されるはずです。 しかし、このdelegateメソッドの中で <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">self.assertIsolated()</code> するとエラーになってしまいました。<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> がフルSwiftで実装されていれば <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> インスタンスがisolation boundaryを超えるのをコンパイラが許さないので、そのようなことは起こせないと思います。 これは、 <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">AVSpeechSynthesizer</code> がObj-Cで実装されているため、Obj-Cを経由することで（Swiftコンパイラの感知できないところでisolation boundaryを越えて）穴が生まれてしまったと考えるのが良いでしょうか？</span> <span class="chatlog__edited-timestamp" title="Sunday, October 13, 2024 10:37 AM">(edited)</span></div>
      </div>
    </div>
  </div>
</div>