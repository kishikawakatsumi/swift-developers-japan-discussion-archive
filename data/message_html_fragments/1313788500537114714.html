<div class="chatlog__message-group">
  <div id="chatlog__message-container-1313788500537114714" class="chatlog__message-container" data-message-id="1313788500537114714">
    <div class="chatlog__message">
      <div class="chatlog__message-aside"><img class="chatlog__avatar" src="https://cdn.discordapp.com/avatars/291075091025100810/39d60f97ea2bca395f1992c42f25107c.png?size=512" alt="Avatar" loading="lazy"></div>
      <div class="chatlog__message-primary">
        <div class="chatlog__header"><span class="chatlog__author" style="color:rgb(155,89,182)" title="kishikawakatsumi" data-user-id="291075091025100810">Kishikawa Katsumi</span> <a href="/channels/291054454793306112?category=main&amp;channel=swift&amp;message_id=1313788500537114714"><span class="chatlog__timestamp" title="Wednesday, December 4, 2024 8:46 AM"></span></a><a href="#chatlog__message-container-1313788500537114714">12/4/2024 8:46 AM</a></div>
        <div class="chatlog__content chatlog__markdown"><span class="chatlog__markdown-preserve"><code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">private func send&lt;Request: Message.Request&gt;(_ message: Request) async throws -&gt; Request.Response { let packet = message.encoded() let data = try await connection.send(sign(packet)) let response = Request.Response(data: data) return response }</code> 上記のコードはSMB2のメッセージを送る処理です。 <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">let request = SessionSetup.Request( messageId: messageId.next(), sessionId: response.header.sessionId, securityMode: [.signingEnabled], capabilities: [], previousSessionId: 0, securityBuffer: authenticateMessage.encoded() ) let response = try await send(request) // ^ SessionSetup.Request.Response</code> ^ このように使って<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">response</code>はリクエストに対応するレスポンス型が返ります。 SMB2には複合リクエストという仕組みがあって、一度に複数のリクエストをまとめて送れて往復のオーバーヘッドを減らせます。 それをVariadic GenericsとParameter Packsで書こうと思って次のようなシグネチャの関数を考えたのですが、 <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">private func send&lt;each Request: Message.Request&gt;(_ messages: repeat each Request) async throws -&gt; (repeat (each Request).Response)</code> 複合リクエストの処理は各リクエストメッセージを8バイト境界に揃えて連結して、各リクエストのヘッダーに次のメッセージのオフセット位置を設定する、というものなので、これは現在のParameter Packsだと書けないですよね？ <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">private func send&lt;each Request: Message.Request&gt;(_ messages: repeat each Request) async throws -&gt; (repeat (each Request).Response) { let responses: (repeat (each Request).Response) for message in repeat each messages { ... // messageをエンコードして8バイトに揃えながら連結してオフセットをセット } ... // 連結したメッセージを送ってレスポンスを受け取る（ここまではできる） responses = ??? // ^ 受け取ったレスポンスをリクエストに対応するレスポンス型に格納したい（できない？） return responses }</code> 引数のmessagesをループすることはできるけどそれを処理した後で戻り値の<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">(repeat (each Request).Response)</code>に詰め直す方法がないように見える。 使うほうは <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">let (createResponse, queryInfoResponse, closeResponse) = try await send(createRequest, queryInfoRequest, closeRequest) // createResponse: Create.Request.Response // queryInfoResponse: QueryInfo.Request.Response // closeResponse: Close.Request.Response</code> こんな感じで送ったリクエストに対応する型のレスポンスが返るようにしたい。</span></div>
      </div>
    </div>
  </div>
</div>