<div class="chatlog__message-group">
  <div id="chatlog__message-container-1334396925751070763" class="chatlog__message-container" data-message-id="1334396925751070763">
    <div class="chatlog__message">
      <div class="chatlog__message-aside"><img class="chatlog__avatar" src="https://cdn.discordapp.com/avatars/431049118421483540/718f2e1723b7d3211c3416afb97436e3.png?size=512" alt="Avatar" loading="lazy"></div>
      <div class="chatlog__message-primary">
        <div class="chatlog__header"><span class="chatlog__author" title="masakihori" data-user-id="431049118421483540">masakihori</span> <a href="/channels/291054454793306112?category=main&amp;channel=swift&amp;message_id=1334396935876120657"><span class="chatlog__timestamp" title="Thursday, January 30, 2025 5:36 AM"></span></a><a href="#chatlog__message-container-1334396925751070763">1/30/2025 5:36 AM</a></div>
        <div class="chatlog__content chatlog__markdown"><span class="chatlog__markdown-preserve">ごちゃごちゃなのでまとめました</span></div>
      </div>
    </div>
  </div>
  <div id="chatlog__message-container-1334396935876120657" class="chatlog__message-container" data-message-id="1334396935876120657">
    <div class="chatlog__message">
      <div class="chatlog__message-aside">
        <div class="chatlog__short-timestamp" title="Thursday, January 30, 2025 5:37 AM">5:37 AM</div>
      </div>
      <div class="chatlog__message-primary">
        <div class="chatlog__content chatlog__markdown"><span class="chatlog__markdown-preserve">2つの型<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">T</code>, <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">U</code>を考えそれぞれの値を<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">t</code>, <code class="chatlog__markdown-pre chatlog__markdown-pre--inline">u</code>とします。 ここで関数 <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">func ~= (_ lhs: U, _ rhs: T) -&gt; Bool</code> が存在するとすると、if-case文 <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">if case u = t { ... }</code> がコンパイルでき正しく動作します。 ここで、<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">Optional&lt;T&gt;</code>型の値を<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">ot</code>とすると、if-case文 <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">if case u? = ot { ... } // あるいは上と同等の if case .some(u) = ot { ... }</code> がコンパイルでき、もっともらしい動作を行います。 この動作は <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">if ot.map({ u ~= $0 }) ?? false { ... }</code> と同じで、<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">ot</code>が<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">nil</code>なら<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">false</code>、そうでないなら<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">u ~= ot!</code>の結果を用いる、となります。 この<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">.some(u)</code>を用いたif-case文は、僕が調べた限り仕様に存在せず、これがコンパイル可能であることが問題である可能性があります。 さらに、<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">.some(u)</code>の型が何であるのかを考えます。 これはもちろん<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">Optional&lt;U&gt;</code>であるはずです。 ところが <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">if case Optional&lt;U&gt;.some(u) = ot { ... }</code> はコンパイルエラーとなります。 エラーの内容は「<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">Optional&lt;U&gt;</code>型は<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">Optional&lt;T&gt;</code>型と合致しない」です。 では先の<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">.some(u)</code>の型は何なのか。ここでとんでもない値を導入します。 <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">Optional&lt;T&gt;.some(u)</code> もちろんこの値は間違いです。この値は<strong>Swiftの世界には存在してはならない</strong>値です。 にもかかわらず <code class="chatlog__markdown-pre chatlog__markdown-pre--multiline language-swift">if case Optional&lt;T&gt;.some(u) = ot { ... }</code> はコンパイル可能で<code class="chatlog__markdown-pre chatlog__markdown-pre--inline">.some(u)</code>を用いた場合と同様の動作を行います。 つまり本来存在してはならない値を含むプログラムがコンパイルできてしまう。 というのが今回の問題です。</span> <span class="chatlog__edited-timestamp" title="Thursday, January 30, 2025 7:54 AM">(edited)</span></div>
      </div>
    </div>
  </div>
</div>